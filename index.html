<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .sortable-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sortable-item {
            background-color: #f4f4f4;
            padding: 10px;
            margin-bottom: 5px;
            cursor: grab;
        }

        .sortable-item:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>

<h2>Sortable List</h2>

<ul class="sortable-list" id="sortable-list">
    <!-- Data will be dynamically added here -->
</ul>
<button id="apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
    let data = [{'id': '86enmz9cu', 'name': '–ó–∞–¥–∞—á–∞ 2', 'priority': 1, 'time_estimate': 21600000, 'status': 'to do', 'start_date': 1710104400000, 'due_date': 1710136800000, 'priority_name': 'urgent', 'priority_color': 'üî¥', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enq019m', 'name': '–ó–∞–¥–∞—á–∞ 3 –±–ª–æ–∫ –±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞', 'priority': 2, 'time_estimate': 7200000, 'status': 'to do', 'start_date': 1710190800000, 'due_date': 1710223200000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800681887', 'depends_info': [{'available_start_time': 0, 'block_id': '86entwrxj', 'name': '–ë–ª–∫ –±–µ–∑ –¥–µ–¥–ª–∞–π–Ω–∞'}]}, {'id': '86enmz9f0', 'name': '–ó–∞–¥–∞—á–∞ 4', 'priority': 2, 'time_estimate': 3600000, 'status': 'to do', 'start_date': 1710190800000, 'due_date': 1710223200000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enmz9e7', 'name': '–ó–∞–¥–∞—á–∞  5', 'priority': 2, 'time_estimate': 14400000, 'status': 'to do', 'start_date': 1710190800000, 'due_date': 1710309600000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enmz9ef', 'name': '–ó–∞–¥–∞—á–∞  6', 'priority': 2, 'time_estimate': 18000000, 'status': 'to do', 'start_date': 1710277200000, 'due_date': 1710309600000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enq01c1', 'name': '–ó–∞–¥–∞—á–∞  7s', 'priority': 3, 'time_estimate': 10800000, 'status': 'to do', 'start_date': 1710363600000, 'due_date': 1710396000000, 'priority_name': 'normal', 'priority_color': 'üîµ', 'list_name': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800681887', 'depends_info': []}, {'id': '86enmz9dp', 'name': '–ó–∞–¥–∞—á–∞ 8l', 'priority': 3, 'time_estimate': 10800000, 'status': 'to do', 'start_date': 1710363600000, 'due_date': 1710396000000, 'priority_name': 'normal', 'priority_color': 'üîµ', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enq018c', 'name': '–ó–∞–¥–∞—á–∞ 1 –±–ª–æ–∫ —Å –¥–µ–ª–∞–π–Ω–æ–º', 'priority': 1, 'time_estimate': 12600000, 'status': 'to do', 'start_date': 1710450000000, 'due_date': 1710482400000, 'priority_name': 'urgent', 'priority_color': 'üî¥', 'list_name': '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800681887', 'depends_info': [{'available_start_time': 1710331200000, 'block_id': '86ente3a9', 'name': '–ë–ª–æ–∫–∏—Ä—É—é—â–∏–π —Å –¥–µ–¥–ª–∞–π–Ω–æ–º'}, {'available_start_time': 1710374400000, 'block_id': '86entz09w', 'name': '—Ç–µ—Å—Ç –¥–ª—è –õ–µ—Ä—ã'}]}, {'id': '86enmz9d5', 'name': '–ó–∞–¥–∞—á–∞ 9l', 'priority': 4, 'time_estimate': 7200000, 'status': 'to do', 'start_date': 1710450000000, 'due_date': 1710482400000, 'priority_name': 'low', 'priority_color': '‚ö™Ô∏è', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': []}, {'id': '86enmz9er', 'name': '–ó–∞–¥–∞—á–∞  10', 'priority': 2, 'time_estimate': 10800000, 'status': 'to do', 'start_date': 1710450000000, 'due_date': 1710568800000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': '–î–ª—è –ê–∑–∞–º–∞—Ç–∞', 'list_id': '901800378539', 'depends_info': [{'available_start_time': 0, 'block_id': '86enmz9d5', 'name': '–ó–∞–¥–∞—á–∞ 9l'}, {'available_start_time': 0, 'block_id': '86enmz9ef', 'name': '–ó–∞–¥–∞—á–∞  6'}]}, {'id': '86enqwvwf', 'name': '–ó–∞–¥–∞—á–∞ 11', 'priority': 1, 'time_estimate': 10800000, 'status': 'to do', 'start_date': 1710536400000, 'due_date': 1710568800000, 'priority_name': 'urgent', 'priority_color': 'üî¥', 'list_name': 'Low Prio', 'list_id': '901800728035', 'depends_info': []}, {'id': '86enqwvyq', 'name': '–ó–∞–¥–∞—á–∞ 12', 'priority': 2, 'time_estimate': 14400000, 'status': 'to do', 'start_date': 1710536400000, 'due_date': 1710655200000, 'priority_name': 'high', 'priority_color': 'üü†', 'list_name': 'Low Prio', 'list_id': '901800728035', 'depends_info': []}];

    // Function to create list items from data
    function createListItems(data) {
        const list = document.getElementById("sortable-list");
        list.innerHTML = ""; // Clear existing items

        for (dataIndex in data) {
            item = data[dataIndex]
            const startDay = getDayOfWeek(new Date(item.start_date).getDay());
            const finishDay = getDayOfWeek(new Date(item.due_date).getDay());
            const timeEstimate = convertMillisToHoursAndMinutes(item.time_estimate);
            let dependsOn = ``

            for (dependIndex in item.depends_info) {
                depend = item.depends_info[dependIndex]
                var color = "000000"
                if (item.start_date < depend.available_start_time) {
                    color = "ff0000"
                }
                if (depend.available_start_time > 0) {
                    readyTimeForBlock = getDayOfWeek(new Date(depend.available_start_time).getDay())
                } else {
                    readyTimeForBlock = '–ù–µ–æ–ø—Ä'
                    for (localIndex in data) {
                        local = data[localIndex]
                        if (depend.block_id === local.id) {
                            readyTimeForBlock = getDayOfWeek(new Date(local.due_date).getDay())
                            if (dataIndex < localIndex) {
                                color = "ff0000"
                            }
                        }
                    }
                }
                dependsOn += `
                        <p>
                        <span>_____${depend.name}</span>
                        <span><strong><font color=${color}>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: ${readyTimeForBlock}</font></strong></span>
                        </p>
                    `
            }

            const listItem = document.createElement("li");
            listItem.className = "sortable-item";
            listItem.innerHTML = `
                <p><strong>${item.priority_color} ${item.name}</strong></p>
                <p>–õ–∏—Å—Ç: ${item.list_name}</p>
                <p>–í—Ä–µ–º—è: ${timeEstimate}</p>
                <p>–°—Ä–æ–∫–∏: ${startDay} - ${finishDay}</p>
                <p>–ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ:</p>
                ${dependsOn}
            `;
            list.appendChild(listItem);
        }
    }

    // Function to get day of the week from its numeric value (0-6)
    function getDayOfWeek(day) {
        const daysOfWeek = ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"];
        return daysOfWeek[day];
    }

    function convertMillisToHoursAndMinutes(milliseconds) {
        const hours = Math.floor(milliseconds / (1000 * 60 * 60));
        const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
        return hours + "h " + minutes + "m";
    }

    function evaluateGantt() {
        // Call evaluate_gantt function passing current data
        evaluate_gantt(data);

        // Update list items after evaluation
        createListItems(data);
    }

    function evaluate_gantt(tickets) {
        const original = 21600000;
        const now = new Date();
        let work_time = original;
        const monday_date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1);
        let day_of_month = 0;

        for (let i = 0; i < tickets.length; i++) {
            let new_date = new Date(monday_date);
            new_date.setDate(new_date.getDate() + day_of_month);
            const start_date = new_date.getTime();
            let finish_date = new_date.getTime()

            if (tickets[i].time_estimate <= work_time) {
                new_date.setHours(18, 0, 0, 0);
                finish_date = new_date.getTime();
                work_time -= tickets[i].time_estimate;
                if (work_time <= 0) {
                    day_of_month += 1;
                    work_time += original;
                }
            } else {
                day_of_month += 1;
                new_date = new Date(monday_date);
                new_date.setDate(new_date.getDate() + day_of_month);
                work_time = work_time - tickets[i].time_estimate + original;
                new_date.setHours(18, 0, 0, 0);
                finish_date = new_date.getTime();
            }

            tickets[i].start_date = start_date;
            tickets[i].due_date = finish_date;
        }
        return tickets;
    }

    // Initialize SortableJS
    const sortable = new Sortable(document.getElementById("sortable-list"), {
        animation: 150,
        onEnd: function (evt) {
            // Update data order after dragging
            const item = data.splice(evt.oldIndex, 1)[0];
            data.splice(evt.newIndex, 0, item);
            evaluateGantt();
        }
    });

    // Initialize list with sample data
    createListItems(data);
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    // Function to send data to Django
    function sendDataToDjango() {
        // Create an AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/formation", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        const csrftoken = getCookie('csrftoken');
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
        const params = getQueryParams()
        const formation_id = params.formation_id
        const object = {
            'formation_id': Number(formation_id),
            'data': data
        }
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) { // Request completed
                if (xhr.status === 200) { // Successful response
                    const response = JSON.parse(xhr.responseText);
                    const formation = response.formation.replace(/"/g, '').replace(/'/g, '"')
                    data = JSON.parse(formation)
                    evaluateGantt()
                } else {
                    console.error('Request failed with status:', xhr.status); // Log error for failed requests
                }
            }
        };

        // Send data to Django
        xhr.send(JSON.stringify(object));
    }

    let tg = window.Telegram.WebApp;
    let apply = document.getElementById("apply")
    apply.addEventListener("click", () => {
        sendDataToDjango()
    })

    function getQueryParams() {
        const queryParams = new URLSearchParams(window.location.search);
        const params = {};
        for (const [key, value] of queryParams.entries()) {
            params[key] = value;
        }
        return params;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>
